<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		<title>Mapa com disponibilidade de tecnologias serviços Claro Fixa no Brasil</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">		
		<link rel="icon" type="image/x-icon" href="./favicon.ico">
		<link rel="stylesheet" href="./js/leaflet/leaflet.css" />
		<link rel="stylesheet" href="./css/css.css" />
		<link rel="preload" as="script" type="text/javascript" href="./js/jquery-3.7.0.min.js" />
		<link rel="preload" as="script" type="text/javascript" href="./js/leaflet/leaflet.js" />
		<link rel="preload" as="script" type="text/javascript" href="./js/script.js" />
		<link rel="preload" as="image" type="image/png" href="./img/marker-icon-black.png" />
		<link rel="preload" as="image" type="image/png" href="./img/marker-icon-green.png" />
		<link rel="preload" as="image" type="image/png" href="./img/marker-icon-grey.png" />
		<link rel="preload" as="image" type="image/png" href="./img/marker-icon-orange.png" />
		<link rel="preload" as="image" type="image/png" href="./img/marker-icon-red.png" />
		<link rel="preload" as="image" type="image/png" href="./img/marker-icon-violet.png" />
		<link rel="preload" as="image" type="image/png" href="./img/marker-icon-yellow.png" />
		<link rel="prefetch" as="image" type="image/png" href="./img/marker-icon-blue.png" />
		<link rel="prefetch" as="image" type="image/png" href="./img/google_maps_icon.png" />
		<link rel="prefetch" as="image" type="image/svg+xml" href="./img/osm_icon.svg" />
		<link rel="prefetch" as="image" type="image/gif" href="./img/loading.gif" />
		<link rel="prefetch" as="image" type="image/gif" href="./img/loading2.gif" />
		<link rel="prefetch" as="image" type="image/gif" href="./img/loading3.gif" />
		<script type="text/javascript" src="./js/jquery-3.7.0.min.js"></script>
		<script type="text/javascript" src="./js/leaflet/leaflet.js"></script>
		<script type="text/javascript">
			const verData = new URLSearchParams(window.location.search).get("ver-data");
			const scripts = [
				"locations-data-update.js",
				"locations-gpon.js",
				"locations-hfc.js",
				"locations-nada.js",
				"locations-neutrogpon.js",
				"locations-neutrohfc.js",
				"locations-sobrepo.js",
				"locations-erroapi.js",
			];

			function loadScript(arquivo, old = false) {
				let path = old ? `./js/locations/old/${verData}/${arquivo}` : `./js/locations/${arquivo}`;

				$.ajax({
					method: 'GET',
					dataType: "script",
					cache: false,
					url: path,
				})
				.fail(function () {
					$('#telaerro-conteudo').html(`
					<span> Ocorreu algum erro, se possível reporte via <a href="https://github.com/dudu15051505/mapa-claro-beta/issues/" target="_blank">GITHUB</a> com uma print da tela</span> <br>
					Erro ao carregar o dados: ${path} <br>
					`);
					$('#telaerro').show();
					console.error(`Erro ao carregar o script: ${path}`);	
				});
			}

			if (verData) {
				scripts.forEach((script) => loadScript(script, true));
			} else {
				scripts.forEach((script) => loadScript(script, false));
			}

			$.ajax({
				url: './js/locations/locations-data-lista.json',
				method: 'GET',
				dataType: 'json',
				cache: false,
				async: true,
				success: function (data) {
					$.each(data, function (index, value) {
						let tempDate = new Date(value.data);
						let formattedDate = `${tempDate.getDate() + 1}/${tempDate.getMonth() + 1}/${tempDate.getFullYear()}`;
						let option = $('<option></option>').attr('value', value.valorCampo).text(value.informacaoExtra ? `${formattedDate} - ${value.informacaoExtra}` : `${formattedDate}`);
						$('#lista-data-dados').append(option);
						$('#dados-info').append(`<span id="dados-info-${index}" style="display: none;"><a href="${value.url}" target="_blank">${value.textoUrl}</a></span>`);
					});
				},
				complete: function () {
					if (verData) {
						$('#lista-data-dados option[value="' + verData + '"]').attr('selected', true);
					} else {
						$('#lista-data-dados option:last').attr('selected', true);
					}

					$('#dados-info-' + $('#lista-data-dados').prop('selectedIndex')).show();
				},
				error: function () {
					console.error('Erro ao carregar lista de dados passados.');
					//alert('Erro ao carregar lista de dados passados.');
					$('#telaerro-conteudo').html('Erro ao carregar lista de dados passados.');
					$('#telaerro').show();
				}
			});

			$(document).ready(function() {
				$(`#lista-data-dados`).on(`change`, function() {
					let value = $(this).val();
					$(location).prop(`href`, `./index.html?ver-data=${value}`);
				});

				//window.setTimeout($(`aviso-fechar`).on(), 1000);

				$(`#aviso-fechar`).click(function() {
					$(`#aviso`).fadeOut(`slow`);
				});
				
				$(`#telaerro-fechar`).click(function() {
					$(`#telaerro`).fadeOut(`slow`);
				});	
				
				if(!verData) {
					$('#aviso').show();
				}	
			});

			$(document).ajaxStart(function() {
				let urls = [
					`./img/loading.gif`, 
					`./img/loading2.gif`,
					`./img/loading3.gif`
				];
				$(`#loadAjaxImg`).attr(`src`, urls[Math.round(Math.random() * urls.length)]);

				$(`#telaerro`).hide();
				$(`#loadAjax`).show();
			}).ajaxComplete(function() {
				$(`#loadAjax`).hide();
			});
		</script>
	</head>
	<body>
		<div id="map">
		</div>
		<div id="legenda" class="leaflet-control">
			<table class="tg">
				<thead>
					<tr>
						<td>
							<form id="formulario">
								<input placeholder="CEP" type="text" id="cep" minlength="8" maxlength="8" oninput="this.value = this.value.replace(/[^0-9.]/g, ``).replace(/(\..*)\./g, `$1`);" required style="width: 70px;"> <br>
								<input placeholder="Número" type="text" id="numero" minlength="1" maxlength="9" oninput="this.value = this.value.replace(/[^0-9.]/g, ``).replace(/(\..*)\./g, `$1`);" required style="width: 70px;">
								<input type="submit" value="Consultar" />
							</form>
						</td>
					</tr>
					<tr>
						<td style="width: 176px;">
							<label>
								Informações coletadas <br> na data <select name="lista-data-dados" id="lista-data-dados" style="width: 84px;"></select> <br>
							</label>
							<span id="dados-info"></span>
						</td>
					</tr>
					<tr>
						<th class="tg-0lax">LEGENDA</th>
						<th class="tg-0lax">ICONE</th>
						<th class="tg-0lax">TOTAL</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td class="tg-0lax">GPON</td>
						<td class="tg-0lax">
							<span class="center">
							<img height="20" width="15" src="./img/marker-icon-green.png" alt="Marcador GPON"/>
							</span>
						</td>
						<td class="tg-0lax" id="somatorio-gpon">
							<span class="center">0</span>
						</td>
					</tr>
					<tr>
						<td class="tg-0lax">HFC</td>
						<td class="tg-0lax">
							<span class="center">
							<img height="20" width="15" src="./img/marker-icon-red.png" alt="Marcador HFC"/>
							</span>
						</td>
						<td class="tg-0lax" id="somatorio-hfc">
							<span class="center">0</span>
						</td>
					</tr>
					<tr>
						<td class="tg-0lax">Sobreposição HFC e GPON</td>
						<td class="tg-0lax">
							<span class="center">
							<img height="20" width="15" src="./img/marker-icon-yellow.png" alt="Marcador Sobreposição"/>
							</span>
						</td>
						<td class="tg-0lax" id="somatorio-sobre">
							<span class="center">0</span>
						</td>
					</tr>
					<tr>
						<td class="tg-0lax">GPON Rede neutra</td>
						<td class="tg-0lax">
							<span class="center">
							<img height="20" width="15" src="./img/marker-icon-grey.png" alt="Marcador GPON Rede Neutra"/>
							</span>
						</td>
						<td class="tg-0lax" id="somatorio-neutragpon">
							<span class="center">0</span>
						</td>
					</tr>
					<tr>
						<td class="tg-0lax">HFC Rede neutra</td>
						<td class="tg-0lax">
							<span class="center">
							<img height="20" width="15" src="./img/marker-icon-violet.png" alt="Marcador HFC Rede Neutra"/>
							</span>
						</td>
						<td class="tg-0lax" id="somatorio-neutrahfc">
							<span class="center">0</span>
						</td>
					</tr>
					<tr>
						<td class="tg-0lax">Sem serviços FIXO</td>
						<td class="tg-0lax">
							<span class="center">
							<img height="20" width="15" src="./img/marker-icon-black.png" alt="Marcador Sem serviço FIXO"/>
							</span>
						</td>
						<td class="tg-0lax" id="somatorio-nada">
							<span class="center">0</span>
						</td>
					</tr>
					<tr>
						<td class="tg-0lax">ERRO Consulta API</td>
						<td class="tg-0lax">
							<span class="center">
							<img height="20" width="15" src="./img/marker-icon-orange.png" alt="Marcador ERRO Consulta API"/>
							</span>
						</td>
						<td class="tg-0lax" id="somatorio-erroapi">
							<span class="center">0</span>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		<div id="aviso" class="leaflet-control">
			<div id="aviso-conteudo">
				<h3>&nbsp;Mapa com disponibilidade de tecnologias serviços Claro Fixa no Brasil&nbsp;</h3>
				<p><b>Este site não é afiliado à operadora CLARO</b></p>
				<p><b>Para realizar consultas oficiais, utilize o site da <a href="https://planos.claro.com.br/cep" target="_blank">CLARO</a></b></p>
				<p>Código fonte do site disponível no <a href="https://github.com/dudu15051505/mapa-claro" target="_blank">GitHub</a></p>
				<!--<p>As marcações exibidas, são retornadas de consulta de API, a exemplo HFC Rede neutra é retornada, mas nunca ninguém viu essa rede.</p>-->
				<button id="aviso-fechar">FECHAR</button>
			</div>
		</div>
		<div id="loadAjax" class="leaflet-control">
			<div id="loadAjax-conteudo">
				<h3>&nbsp;Carregando&nbsp;</h3>
				<img id="loadAjaxImg" src="#" alt="Carregando"/>
			</div>
		</div>
		<div id="telaerro" class="leaflet-control" style="display: none;">
			<span style="float: right; margin: 5px;">
				<button id="telaerro-fechar">FECHAR</button> <br>
			</span>
			<div id="telaerro-conteudo">
			</div>
		</div>
		<script type="text/javascript" src="./js/script.js"></script>
	</body>
</html>